---
title: web 访问控制
date: 2017-03-28 18:06:54
tags: 访问控制
categories: 技术相关
---

# 控制恶意访问和数据抓取

当网站有了一定的访问量以后，就需要考虑防范恶意刷请求，以及数据抓取等行为。

# 工具

使用[Redis](https://redis.io) 或其他持久化存储技术，存储用户访问行为和 Block 列表。[Redis](https://redis.io) 自带的数据过期时间可以很好的适应时间段判断的逻辑。

# 实现

规定一个时间段 threshold, 以及这个时间段内规定合法的访问次数 times。将判断逻辑置于所有请求之前。
使用一个适当前缀类似 'block' + user_id 作为 block 表的 key 值，这条数据的过期时间即为阻止该用户访问的时间，首先判断访问用户是否在 block 表中，如果在，阻止继续访问，否则获取一个表示当前用户在当前 threshold 时间段内的访问次数的值，该条数据的 key 值可以设定为适当前缀加用户id，类似 'request_rate' + user_id, 该条数据的过期时间即为 threshold 值，value 对应当前用户在该 threshold 时间段内的访问次数。
如果获取不到该条数据，说明用户长时间未访问，则新建一条数据。如果可以获取到则判断  value 值是否小于 times，如果小于则将该条数据的 value 值加一（注意更新过期时间）。如果大于说明存在恶意访问，则将该用户加入 block 列表，阻止访问。
